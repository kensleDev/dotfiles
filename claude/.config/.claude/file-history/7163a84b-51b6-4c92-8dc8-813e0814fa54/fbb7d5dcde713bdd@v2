import { POLAR_ACCESS_TOKEN } from "$env/static/private";
import { auth } from "@/auth/auth.server";
import { db } from "@/db/server";
import { user } from "@/db/server/schema.server";
import { Polar } from "@polar-sh/sdk";
import { eq } from "drizzle-orm";
import { error, redirect } from "@sveltejs/kit";
import type { PageServerLoad } from "./$types";

const polar = new Polar({
  accessToken: POLAR_ACCESS_TOKEN,
  server: "sandbox",
});

export const load = (async ({ url, request }) => {
  const checkoutId = url.searchParams.get("checkout_id");

  if (!checkoutId) {
    throw error(400, "Missing checkout ID");
  }

  console.log({ checkoutId });

  try {
    // Fetch checkout details from Polar
    const checkout = await polar.checkouts.get({
      id: checkoutId,
    });

    console.log({ status: checkout.status });

    if (checkout.status !== "succeeded") {
      throw error(400, "Checkout not completed");
    }

    // Check if user is already authenticated using Better-Auth
    const session = await auth.api.getSession({
      headers: request.headers,
    });

    if (session) {
      // User is already logged in, update their subscription status
      try {
        const subscriptions = await polar.subscriptions.list({
          customerId: checkout.customerId,
        });

        const activeSubscription = subscriptions.result?.items?.find(
          (sub) => sub.status === "active" || sub.status === "trialing"
        );

        // Update user with Polar data
        await db
          .update(user)
          .set({
            polar_customer_id: checkout.customerId || null,
            subscription_status: activeSubscription ? "active" : "inactive",
            current_period_end: activeSubscription?.currentPeriodEnd
              ? new Date(activeSubscription.currentPeriodEnd)
              : null,
          })
          .where(eq(user.id, session.user.id));

        console.log("Existing user subscription updated:", {
          userId: session.user.id,
          email: session.user.email,
          polar_customer_id: checkout.customerId,
          subscription_status: activeSubscription ? "active" : "inactive",
        });

        // Force session refresh by invalidating cookie cache
        // This ensures the next getSession call will fetch fresh data from DB
        await auth.api.getSession({
          headers: request.headers,
          query: {
            disableCookieCache: true,
          },
        });
      } catch (error) {
        console.error("Error updating existing user subscription:", error);
        // Continue to redirect even if update fails
      }

      // Redirect to profile after updating subscription
      throw redirect(303, "/profile");
    }

    // For simplicity, assume we need account creation since user isn't logged in
    // In a real app, you might want to check if account exists via database query
    return {
      checkoutId,
      email: checkout.customerEmail || "",
      needsAccountCreation: true,
    };
  } catch (err) {
    console.error("Error loading success page:", err);

    // If it's a redirect, re-throw it
    if (err instanceof Response) {
      throw err;
    }

    throw error(500, "Failed to verify subscription");
  }
}) satisfies PageServerLoad;
