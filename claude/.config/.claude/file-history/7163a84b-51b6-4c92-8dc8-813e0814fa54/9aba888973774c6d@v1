import { authClient } from "./auth.client";

/**
 * Check if user has an active subscription
 */
export async function hasActiveSubscription(): Promise<boolean> {
  try {
    const customerState = await authClient.customer.state();

    console.log("Customer state:", customerState);

    if (customerState.error || !customerState.data) {
      return false;
    }

    return customerState.data.activeSubscriptions.length > 0;
  } catch (error) {
    console.error("Error checking subscription:", error);
    return false;
  }
}

/**
 * Check if user is authenticated
 */
export async function isAuthenticated(): Promise<boolean> {
  try {
    const session = await authClient.getSession();
    return session.data !== null;
  } catch (error) {
    console.error("Error checking authentication:", error);
    return false;
  }
}

export async function isSubscribed(): Promise<boolean> {
  const [authenticated, hasSubscription] = await Promise.all([
    isAuthenticated(),
    hasActiveSubscription(),
  ]);

  return authenticated && hasSubscription;
}

export async function getAuthState(): Promise<
  "anon" | "unsubscribed" | "subscribed"
> {
  try {
    const loggedIn = await isAuthenticated();
    const hasSub = await isSubscribed();
    const isReady = loggedIn && hasSub;

    console.log({ loggedIn, hasSub, isReady });

    if (loggedIn && !hasSub) return "unsubscribed";
    if (isReady) return "subscribed";
    return "anon";
  } catch (error) {
    console.error("Error getting auth state:", error);
    return "anon";
  }
}

/**
 * Guard for premium features - requires active subscription
 */
export async function requireSubscription(): Promise<boolean> {
  const [authenticated, hasSubscription] = await Promise.all([
    isAuthenticated(),
    hasActiveSubscription(),
  ]);

  return authenticated && hasSubscription;
}

/**
 * Svelte store for subscription status
 */
export function createSubscriptionStore() {
  let subscriptionStatus = $state<"unknown" | "active" | "inactive">("unknown");
  let isLoading = $state(true);

  async function checkStatus() {
    isLoading = true;
    try {
      const hasSubscription = await hasActiveSubscription();
      subscriptionStatus = hasSubscription ? "active" : "inactive";
    } catch (error) {
      console.error("Error checking subscription status:", error);
      subscriptionStatus = "inactive";
    } finally {
      isLoading = false;
    }
  }

  // Check status on creation
  checkStatus();

  return {
    get status() {
      return subscriptionStatus;
    },
    get isLoading() {
      return isLoading;
    },
    refresh: checkStatus,
  };
}
