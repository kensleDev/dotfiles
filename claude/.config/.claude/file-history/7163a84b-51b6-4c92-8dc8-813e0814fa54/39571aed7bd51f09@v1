import { getRequestEvent } from "$app/server";
import {
  GITHUB_CLIENT_ID,
  GITHUB_CLIENT_SECRET,
  POLAR_ACCESS_TOKEN,
  POLAR_PRO_PRODUCT_NAME,
  POLAR_SUCCESS_URL,
} from "$env/static/private";
import {
  PUBLIC_FRONTEND_URL,
  PUBLIC_POLAR_PRO_SUBSCRIPTION_PRODUCT_ID,
} from "$env/static/public";

import { db } from "@/db/server"; // your drizzle instance
import * as schema from "@/db/server/schema.server";
import { checkout, polar, portal, usage } from "@polar-sh/better-auth";
import { Polar } from "@polar-sh/sdk";
import { betterAuth } from "better-auth";
import { drizzleAdapter } from "better-auth/adapters/drizzle";
import { sveltekitCookies } from "better-auth/svelte-kit";

export const auth = betterAuth({
  baseURL: PUBLIC_FRONTEND_URL,
  plugins: [
    sveltekitCookies(getRequestEvent),
    polar({
      client: new Polar({
        accessToken: POLAR_ACCESS_TOKEN,
        // Use 'sandbox' if you're using the Polar Sandbox environment
        // Remember that access tokens, products, etc. are completely separated between environments.
        // Access tokens obtained in Production are for instance not usable in the Sandbox environment.
        server: "sandbox",
      }),
      createCustomerOnSignUp: false, // Changed: Don't create customers on signup
      use: [
        checkout({
          products: [
            {
              productId: PUBLIC_POLAR_PRO_SUBSCRIPTION_PRODUCT_ID,
              slug: POLAR_PRO_PRODUCT_NAME,
            },
          ],
          successUrl: POLAR_SUCCESS_URL,
          authenticatedUsersOnly: false, // Changed: Allow anonymous checkout
        }),
        portal(),
        usage(),
        // webhooks({
        //     secret: process.env.POLAR_WEBHOOK_SECRET,
        //     onCustomerStateChanged: (payload) => // Triggered when anything regarding a customer changes
        //     onOrderPaid: (payload) => // Triggered when an order was paid (purchase, subscription renewal, etc.)
        //     ...  // Over 25 granular webhook handlers
        //     onPayload: (payload) => // Catch-all for all events
        // })
      ],
    }),
  ], // make sure this is the last plugin in the array

  database: drizzleAdapter(db, {
    provider: "pg", // or "mysql", "sqlite"
    schema,
  }),
  emailAndPassword: {
    enabled: true,
  },
  socialProviders: {
    github: {
      clientId: GITHUB_CLIENT_ID,
      clientSecret: GITHUB_CLIENT_SECRET,
      // redirectURI: GITHUB_OAUTH_REDIRECT_URI,
    },
  },
});
