import { dev } from "$app/environment";
import { POLAR_ACCESS_TOKEN } from "$env/static/private";
import { db } from "@/db/server";
import { user } from "@/db/server/schema.server";
import { Polar } from "@polar-sh/sdk";
import type { RequestHandler } from "@sveltejs/kit";
import { json } from "@sveltejs/kit";
import { eq } from "drizzle-orm";
import { z } from "zod";

const completeSignupSchema = z.object({
  email: z.string().email("Invalid email address"),
  name: z.string().min(2, "Name must be at least 2 characters"),
  password: z.string().min(8, "Password must be at least 8 characters"),
  checkoutId: z.string().min(1, "Checkout ID is required"),
  migrateData: z.boolean().optional().default(false),
});

const polar = new Polar({
  accessToken: POLAR_ACCESS_TOKEN,
  server: "sandbox",
});

export const POST: RequestHandler = async ({ request }) => {
  try {
    const body = await request.json();
    const validatedData = completeSignupSchema.parse(body);

    // 1. Verify the checkout exists and was successful
    let checkout;
    try {
      checkout = await polar.checkouts.get({
        id: validatedData.checkoutId,
      });
    } catch (error) {
      console.error("Error fetching checkout:", error);
      return json({ error: "Invalid checkout session" }, { status: 400 });
    }

    console.log({ checkout });
    // 2. Verify checkout is completed and matches the email
    if (checkout.status !== "succeeded") {
      return json({ error: "Checkout not completed" }, { status: 400 });
    }

    if (checkout.customerEmail !== validatedData.email) {
      return json({ error: "Email mismatch" }, { status: 400 });
    }

    // 3. Create the user account with Better-Auth
    // Use HTTP call with proper TLS handling for development
    try {
      const url = new URL(request.url);

      // Temporarily disable TLS verification in development
      const originalRejectUnauthorized =
        process.env.NODE_TLS_REJECT_UNAUTHORIZED;
      if (dev) {
        process.env.NODE_TLS_REJECT_UNAUTHORIZED = "0";
      }

      const signUpResponse = await fetch(
        `${url.origin}/api/auth/sign-up/email`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            email: validatedData.email,
            password: validatedData.password,
            name: validatedData.name,
          }),
        }
      );

      // Restore original TLS setting
      if (dev) {
        if (originalRejectUnauthorized !== undefined) {
          process.env.NODE_TLS_REJECT_UNAUTHORIZED = originalRejectUnauthorized;
        } else {
          delete process.env.NODE_TLS_REJECT_UNAUTHORIZED;
        }
      }

      if (!signUpResponse.ok) {
        const errorData = await signUpResponse.json();
        if (
          signUpResponse.status === 400 &&
          errorData.message?.includes("email")
        ) {
          return json(
            { error: "Account already exists with this email" },
            { status: 409 }
          );
        }
        return json(
          { error: errorData.message || "Failed to create account" },
          { status: 500 }
        );
      }

      const userData = await signUpResponse.json();

      // 5. Update user with Polar customer ID and subscription status
      if (!userData.user?.id) {
        return json({ error: "User creation failed" }, { status: 500 });
      }

      try {
        // Fetch subscription details from Polar
        const subscriptions = await polar.subscriptions.list({
          customerId: checkout.customerId,
        });

        const activeSubscription = subscriptions.result?.items?.find(
          (sub) => sub.status === "active" || sub.status === "trialing"
        );

        // Update user with Polar data
        await db
          .update(user)
          .set({
            polarCustomerId: checkout.customerId || null,
            subscriptionStatus: activeSubscription ? "active" : "inactive",
            currentPeriodEnd: activeSubscription?.currentPeriodEnd
              ? new Date(activeSubscription.currentPeriodEnd)
              : null,
          })
          .where(eq(user.id, userData.user.id));

        console.log("User created and subscription updated:", {
          userId: userData.user.id,
          email: userData.user.email,
          checkoutId: validatedData.checkoutId,
          polarCustomerId: checkout.customerId,
          subscriptionStatus: activeSubscription ? "active" : "inactive",
        });
      } catch (error) {
        console.error("Error updating user subscription:", error);
        // Don't fail the entire request if subscription update fails
        // User account is already created
      }

      return json({
        success: true,
        user: userData.user,
        migrateData: validatedData.migrateData,
      });
    } catch (error) {
      console.error("Error creating user:", error);
      return json({ error: "Failed to create account" }, { status: 500 });
    }
  } catch (error) {
    if (error instanceof z.ZodError) {
      return json(
        { error: "Invalid request data", details: error.issues },
        { status: 400 }
      );
    }

    console.error("Unexpected error:", error);
    return json({ error: "Internal server error" }, { status: 500 });
  }
};
