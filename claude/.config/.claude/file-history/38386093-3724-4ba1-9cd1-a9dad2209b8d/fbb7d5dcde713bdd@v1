import { POLAR_ACCESS_TOKEN } from "$env/static/private";
import { auth } from "@/auth/auth.server";
import { Polar } from "@polar-sh/sdk";
import { error, redirect } from "@sveltejs/kit";
import type { PageServerLoad } from "./$types";

const polar = new Polar({
  accessToken: POLAR_ACCESS_TOKEN,
  server: "sandbox",
});

export const load = (async ({ url, request }) => {
  const checkoutId = url.searchParams.get("checkout_id");

  if (!checkoutId) {
    throw error(400, "Missing checkout ID");
  }

  console.log({ checkoutId });

  try {
    // Fetch checkout details from Polar
    const checkout = await polar.checkouts.get({
      id: checkoutId,
    });

    console.log({ status: checkout.status });

    if (checkout.status !== "succeeded") {
      throw error(400, "Checkout not completed");
    }

    // Check if user is already authenticated using Better-Auth
    const session = await auth.api.getSession({
      headers: request.headers,
    });

    if (session) {
      // User is already logged in, redirect to profile
      throw redirect(303, "/profile");
    }

    // For simplicity, assume we need account creation since user isn't logged in
    // In a real app, you might want to check if account exists via database query
    return {
      checkoutId,
      email: checkout.customerEmail || "",
      needsAccountCreation: true,
    };
  } catch (err) {
    console.error("Error loading success page:", err);

    // If it's a redirect, re-throw it
    if (err instanceof Response) {
      throw err;
    }

    throw error(500, "Failed to verify subscription");
  }
}) satisfies PageServerLoad;
