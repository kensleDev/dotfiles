<script lang="ts">
	import { goto } from '$app/navigation';
	import { resolve } from '$app/paths';
	import * as Resizable from '$lib/components/ui/resizable/index.js';
	import { Button } from '@/components/ui/button';
	import { DEFAULT_WORKSPACE_ID } from '@/constants/workspace';
	import { createBlankPage } from '@/db/client/repos/page.repo.svelte';
	import Sidebar from '@/features/shell/sidebar';
	import { authStore } from '@/state/auth.store.svelte';
	import { dialogsStore } from '@/state/dialogs.store.svelte';
	import { pagesStore } from '@/state/pages.store.svelte';
	import { sidebarStore } from '@/state/sidebar.store.svelte';
	import AppDialogs from './AppDialogs.svelte';

	let { pageId, children } = $props();

	let sidebarComponent: { toggleSidebar: () => void; getSidebarState: () => boolean };
	let sidebarSize = $state(25);

	const workspaceId = DEFAULT_WORKSPACE_ID;

	// let currentPageId = $derived($page.url.searchParams.get('pg') ?? '');

	async function handleNewPageSubmit(data: { title: string; parentPageId?: string }) {
		const { title, parentPageId } = data;
		console.log({ title, parentPageId, workspaceId });

		try {
			if (!title?.trim()) return;
			const newPage = await createBlankPage(
				authStore.user?.id ?? '',
				authStore.member?.orgId ?? '',
				title.trim(),
				parentPageId ?? '',
				''
			);
			const url = `/e?pg=${newPage.id}&workspaceId=${workspaceId}`;
			goto(resolve(url));
			await pagesStore.refetchPagesWithoutContent();
		} catch (error) {
			console.error({ error });
		}

		dialogsStore.newPageDialog.close();
		dialogsStore.resetNewPageContext();
	}

	async function onCreatePage(title: string, parentPageId?: string) {
		dialogsStore.openNewPageDialog(parentPageId, title);
	}

	// Effect to handle sidebar collapse/expand
	$effect(() => {
		if (sidebarComponent) {
			const isOpen = sidebarComponent.getSidebarState();
			sidebarSize = isOpen ? 25 : 1; // Keep it at 1 instead of 0 to prevent DOM removal
			sidebarStore.setSidebarState(isOpen);
		}
	});

	// Effect to restore sidebar when store state changes to open
	$effect(() => {
		if (sidebarStore.isSidebarOpen && sidebarSize === 1 && sidebarComponent) {
			// Force the sidebar component to open
			sidebarComponent.toggleSidebar();
		}
	});
</script>

<Resizable.PaneGroup direction="horizontal" class="min-h-[200px] rounded-lg border">
	<Resizable.Pane
			defaultSize={25}
			minSize={25}
			maxSize={40}
			class="hidden md:block"
			bind:size={sidebarSize}
		>
			<Sidebar.Root
				pages={pagesStore.pagesWithoutContent}
				bind:this={sidebarComponent}
				{onCreatePage}
				{workspaceId}
				currentPageId={pageId}
				onRename={async (pageId: string, newTitle: string) => {
					console.log('Rename page:', { pageId, newTitle });
					// Will be handled by the dialog in PageTreeItemMenu
				}}
				onDelete={async (pageId: string) => {
					console.log('Delete page:', { pageId });
					// Will be handled by the dialog in PageTreeItemMenu
				}}
			/>
			<!-- <div class="flex h-full items-center justify-center p-6">
        <span class="font-semibold">Sidebar</span>
      </div> -->
		</Resizable.Pane>

	<Resizable.Handle withHandle class="md:hidden" />
	<Resizable.Pane defaultSize={75}>
		<div class="min-[650px]:relative">
			<!-- Mobile hamburger menu - shows when sidebar is hidden -->
			{#if sidebarComponent?.getSidebarState() === false}
				<Button onclick={() => sidebarComponent?.toggleSidebar()} aria-label="Show sidebar">
					<svg
						xmlns="http://www.w3.org/2000/svg"
						class="h-6 w-6"
						fill="none"
						viewBox="0 0 24 24"
						stroke="currentColor"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="2"
							d="M4 6h16M4 12h16M4 18h16"
						/>
					</svg>
				</Button>
			{/if}

			<div
				class="transition-all duration-300 {sidebarComponent?.getSidebarState() === false
					? 'min-[650px]:pl-16'
					: ''}"
			>
				{@render children()}
			</div>
		</div>
		<!-- <div class="flex h-full items-center justify-center p-6">
      <span class="font-semibold">Content</span>
    </div> -->
	</Resizable.Pane>

	<AppDialogs
		{workspaceId}
		orgId={authStore.member?.orgId || ''}
		userId={authStore.user?.id || ''}
		onSubmit={handleNewPageSubmit}
	/>
</Resizable.PaneGroup>
