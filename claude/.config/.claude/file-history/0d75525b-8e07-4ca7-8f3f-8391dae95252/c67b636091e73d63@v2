<script lang="ts">
	import { page } from '$app/stores';
	import {
		CommandDialog,
		CommandEmpty,
		CommandGroup,
		CommandInput,
		CommandItem,
		CommandSeparator
	} from '@/components/ui/command';
	import type { PageWithoutContent } from '@/db/client/triplit/schema';
	import { pagesStore } from '@/state/pages.store.svelte';
	import Fuse from 'fuse.js';
	import type { Editor } from '@tiptap/core';
	import { createHomeCommands, type HomeCommand } from './shared/homeCommands';
	import { createPageActions, type PageAction } from './shared/pageActions';
	import { BlockActions } from './blockActions.svelte.ts';

	type CommandPalleteItem = {
		title: string;
		description: string;
		icon?: string;
		command: () => void;
		pageId?: string;
		value?: string;
	};

	type Props = {
		isOpen?: boolean;
		items?: CommandPalleteItem[];
		inputValue?: string;
		onSelect?: (item: CommandPalleteItem) => void;
		onPageSelect?: (pageId: string) => void;
		pageId?: string;
		initialPageTitle?: string;
		onRename?: (data: { pageId: string; newTitle: string }) => void;
		onDelete?: (pageId: string) => void;
		onCreatePage?: () => void;
		onImportMarkdown?: () => void;
		onNewWorkspace?: () => void;
		editor?: Editor;
	};

	// Props
	let {
		isOpen = $bindable(),
		items = [],
		inputValue = '',
		onSelect,
		onPageSelect,
		pageId,
		initialPageTitle,
		onRename,
		onDelete,
		onCreatePage,
		onImportMarkdown,
		onNewWorkspace,
		editor
	}: Props = $props();

	// State
	let fuse: Fuse<PageWithoutContent> | null = $state(null);

	// Check if we're on the /e route to show page actions
	let isOnEditorRoute = $derived($page.url.pathname.includes('/e'));

	// Check if we're on the /home route to show home commands
	let isOnHomeRoute = $derived($page.url.pathname.includes('/home'));

	// Create page actions if we have the required props and are on editor route
	let pageActions = $derived.by(() => {
		if (!isOnEditorRoute || !pageId || !initialPageTitle || !onRename || !onDelete) {
			return [];
		}
		return createPageActions(pageId, initialPageTitle, onRename, onDelete, {
			onClose: () => {
				isOpen = false;
				inputValue = '';
			}
		});
	});

	// Create home commands if we're on home route
	let homeCommands = $derived.by(() => {
		if (!isOnHomeRoute || !onCreatePage || !onImportMarkdown || !onNewWorkspace) {
			return [];
		}
		return createHomeCommands({
			onCreatePage: () => {
				onCreatePage();
				isOpen = false;
				inputValue = '';
			},
			onImportMarkdown: () => {
				onImportMarkdown();
				isOpen = false;
				inputValue = '';
			},
			onNewWorkspace: () => {
				onNewWorkspace();
				isOpen = false;
				inputValue = '';
			}
		});
	});

	// Create editor actions if we're on editor route and have editor
	let editorActions = $derived.by(() => {
		if (!isOnEditorRoute || !editor) {
			return [];
		}
		const blockActions = new BlockActions(editor);
		return blockActions.editorBlockActions.map((action) => ({
			name: action.label,
			icon: action.icon,
			value: action.action,
			description: '',
			action: () => {
				blockActions.handleEditorAction({
					action: action.action as any,
					targetType: undefined
				});
				isOpen = false;
				inputValue = '';
			}
		}));
	});

	// Initialize page search
	$effect(() => {
		if (isOpen && !fuse) {
			pagesStore.initialize().then(() => {
				if (pagesStore.pagesWithoutContent.length > 0) {
					fuse = new Fuse(pagesStore.pagesWithoutContent, {
						keys: ['title'],
						threshold: 0.3,
						minMatchCharLength: 1
					});
				}
			});
		}
	});

	// Filter items based on input
	let filteredItems = $derived.by(() => {
		if (!inputValue) return items;
		return items.filter(
			(item) =>
				item.title.toLowerCase().includes(inputValue.toLowerCase()) ||
				item.description.toLowerCase().includes(inputValue.toLowerCase())
		);
	});

	// Search pages as fallback
	let pageSearchResults = $derived.by(() => {
		if (!inputValue || filteredItems.length > 0 || !fuse) {
			return [];
		}

		const results = fuse.search(inputValue);
		return results.slice(0, 5).map((result) => ({
			title: result.item.title,
			description: `Created ${new Date(result.item.createdAt).toLocaleDateString()}`,
			icon: 'ðŸ“„',
			command: () => handlePageSelect(result.item.id),
			pageId: result.item.id,
			value: `page-${result.item.id}`
		}));
	});

	function handlePageSelect(pageId: string) {
		if (onPageSelect) {
			onPageSelect(pageId);
		}
		isOpen = false;
		inputValue = '';
	}

	function handleSelect(item: CommandPalleteItem) {
		// If it's a page item, handle it specially
		if (item.pageId) {
			handlePageSelect(item.pageId);
			return;
		}

		if (onSelect) {
			onSelect(item);
		}
		item.command();
		isOpen = false;
		inputValue = '';
	}

	function handlePageActionSelect(action: PageAction) {
		if (action.action) {
			action.action();
		}
		if (action.onSelect) {
			action.onSelect();
		}
	}

	function handleHomeCommandSelect(command: HomeCommand) {
		command.action();
	}

	function handleOpenChange(open: boolean) {
		isOpen = open;
		if (!open) {
			inputValue = '';
		}
	}
</script>

<CommandDialog
	open={isOpen}
	onOpenChange={handleOpenChange}
	portalProps={{ class: 'top-[33%] translate-y-0' }}
>
	<CommandInput
		class="border-none outline-none focus-visible:ring-0"
		placeholder="Search commands or pages..."
		bind:value={inputValue}
	/>
	<CommandEmpty>No results found.</CommandEmpty>
	<CommandSeparator />

	{#if filteredItems.length > 0}
		<CommandGroup heading="Commands">
			{#each filteredItems as item (item.title)}
				<CommandItem
					data-value={item.value || item.title}
					onclick={() => handleSelect(item)}
					class="cursor-pointer"
				>
					{#if item.icon}
						<span class="mr-2 text-lg">{item.icon}</span>
					{/if}
					<div class="flex flex-col">
						<span class="font-medium">{item.title}</span>
						<span class="text-xs text-muted-foreground">{item.description}</span>
					</div>
				</CommandItem>
			{/each}
		</CommandGroup>
	{/if}

	{#if homeCommands.length > 0}
		<CommandGroup heading="Actions">
			{#each homeCommands as command (command.value)}
				<CommandItem
					data-value={command.value}
					onclick={() => handleHomeCommandSelect(command)}
					class="cursor-pointer"
				>
					{#if command.icon}
						<command.icon class="mr-2 h-4 w-4" />
					{/if}
					<div class="flex flex-col">
						<span class="font-medium">{command.name}</span>
						<span class="text-xs text-muted-foreground">{command.description}</span>
					</div>
				</CommandItem>
			{/each}
		</CommandGroup>
	{/if}

	{#if pageActions.length > 0}
		<CommandGroup heading="Page">
			{#each pageActions as action (action.name)}
				<CommandItem
					data-value={action.value || action.name}
					onclick={() => handlePageActionSelect(action)}
					class="cursor-pointer"
				>
					{#if action.icon}
						<action.icon class="mr-2 h-4 w-4" />
					{/if}
					{action.name}
				</CommandItem>
			{/each}
		</CommandGroup>
	{/if}

	{#if editorActions.length > 0}
		<CommandGroup heading="Format">
			{#each editorActions as action (action.value)}
				<CommandItem
					data-value={action.value}
					onclick={action.action}
					class="cursor-pointer"
				>
					{#if action.icon}
						<action.icon class="mr-2 h-4 w-4" />
					{/if}
					<div class="flex flex-col">
						<span class="font-medium">{action.name}</span>
						<span class="text-xs text-muted-foreground">{action.description}</span>
					</div>
				</CommandItem>
			{/each}
		</CommandGroup>
	{/if}

	{#if pageSearchResults.length > 0}
		<CommandGroup heading="Pages">
			{#each pageSearchResults as item (item.title)}
				<CommandItem
					data-value={item.value || item.title}
					onclick={() => handleSelect(item)}
					class="cursor-pointer"
				>
					{#if item.icon}
						<span class="mr-2 text-lg">{item.icon}</span>
					{/if}
					<div class="flex flex-col">
						<span class="font-medium">{item.title}</span>
						<span class="text-xs text-muted-foreground">{item.description}</span>
					</div>
				</CommandItem>
			{/each}
		</CommandGroup>
	{/if}
</CommandDialog>
