<script lang="ts">
	import { Editor } from '@tiptap/core';
	import Bold from '@tiptap/extension-bold';
	import BulletList from '@tiptap/extension-bullet-list';
	import CodeBlockLowlight from '@tiptap/extension-code-block-lowlight';
	import Document from '@tiptap/extension-document';
	import Heading from '@tiptap/extension-heading';
	import History from '@tiptap/extension-history';
	import HorizontalRule from '@tiptap/extension-horizontal-rule';
	import Italic from '@tiptap/extension-italic';
	import Link from '@tiptap/extension-link';
	import ListItem from '@tiptap/extension-list-item';
	import Paragraph from '@tiptap/extension-paragraph';
	import Text from '@tiptap/extension-text';
	import { Plugin, PluginKey } from '@tiptap/pm/state';
	import { createLowlight } from 'lowlight';
	import { onDestroy, onMount } from 'svelte';
	import CommandPalette from './CommandPalette.svelte';
	import type { SlashCommandItem } from './extensions/SlashCommand';
	import { MarkdownPasteHandler } from './markdown/pasteHandler';
	import ImportMarkdownButton from './components/ImportMarkdownButton.svelte';

	let {
		pageId,
		orgId,
		currentUser
	}: {
		pageId: string;
		orgId: string;
		currentUser: { id: string; name: string; color?: string };
	} = $props();

	let element: HTMLElement;
	let editor = $state<Editor>();
	let commandPaletteOpen = $state(false);
	let commandPalettePosition = $state({ x: 0, y: 0 });
	let commandPaletteRange = $state<{ from: number; to: number } | null>(null);
	// let commandPaletteInput: HTMLInputElement;

	const lowlight = createLowlight();

	// Slash command items
	const slashCommands: SlashCommandItem[] = [
		{
			title: 'Heading 1',
			description: 'Large heading',
			icon: 'H1',
			command: ({ editor, range }) => {
				editor.chain().focus().deleteRange(range).setHeading({ level: 1 }).run();
			}
		},
		{
			title: 'Heading 2',
			description: 'Medium heading',
			icon: 'H2',
			command: ({ editor, range }) => {
				editor.chain().focus().deleteRange(range).setHeading({ level: 2 }).run();
			}
		},
		{
			title: 'Heading 3',
			description: 'Small heading',
			icon: 'H3',
			command: ({ editor, range }) => {
				editor.chain().focus().deleteRange(range).setHeading({ level: 3 }).run();
			}
		},
		{
			title: 'Bullet List',
			description: 'Create a bullet list',
			icon: '•',
			command: ({ editor, range }) => {
				editor.chain().focus().deleteRange(range).toggleBulletList().run();
			}
		},
		{
			title: 'Code Block',
			description: 'Insert a code block',
			icon: '</>',
			command: ({ editor, range }) => {
				editor.chain().focus().deleteRange(range).setCodeBlock().run();
			}
		},
		{
			title: 'Divider',
			description: 'Insert a horizontal divider',
			icon: '—',
			command: ({ editor, range }) => {
				editor.chain().focus().deleteRange(range).setHorizontalRule().run();
			}
		}
	];

	function handleSlashCommandSelect(event: CustomEvent<{ item: SlashCommandItem }>) {
		const { item } = event.detail;
		if (commandPaletteRange) {
			item.command({ editor, range: commandPaletteRange });
		}
		commandPaletteOpen = false;
		commandPaletteRange = null;
	}

	onMount(() => {
		// Ensure we're in browser environment
		if (typeof window === 'undefined') return;

		const slashPlugin = new Plugin({
			key: new PluginKey('slash-command-detect'),
			state: {
				init() {
					return null;
				},
				apply(tr: any) {
					const { selection } = tr;
					const from = selection.$from;
					const textBefore = from.parent.textContent.substring(0, from.parentOffset);

					if (textBefore === '/') {
						return { from: from.pos - 1, to: from.pos };
					}
					return null;
				}
			},
			view() {
				return {
					update: (view: any) => {
						const state = this.key?.getState(view.state);
						if (state) {
							const editorRect = element.getBoundingClientRect();
							const rect = view.coordsAtPos(state.from);
							commandPalettePosition = {
								x: editorRect.left + rect.left,
								y: editorRect.top + rect.bottom + 8
							};
							commandPaletteRange = state;
							commandPaletteOpen = true;
						} else if (commandPaletteOpen) {
							commandPaletteOpen = false;
						}
					}
				};
			}
		});

		editor = new Editor({
			element: element,
			extensions: [
				Document,
				Paragraph,
				Text,
				Bold,
				Italic,
				History,
				Heading.configure({
					levels: [1, 2, 3]
				}),
				BulletList,
				ListItem,
				CodeBlockLowlight.configure({
					lowlight
				}),
				HorizontalRule,
				Link.configure({
					openOnClick: false
				}),
				MarkdownPasteHandler
			],
			autofocus: true,
			editorProps: {
				attributes: {
					class:
						'prose prose-slate dark:prose-invert max-w-none focus:outline-none min-h-[400px] px-4 py-2'
				}
			}
		});

		editor.registerPlugin(slashPlugin);

		console.log({ editor });
	});

	onDestroy(() => {
		editor?.destroy();
	});
</script>

<div class="space-y-4">
	<!-- Toolbar -->
	<div class="flex items-center gap-2">
		{#if editor}
			<ImportMarkdownButton {editor} />
		{/if}
	</div>

	<!-- Editor -->
	<div class="relative">
		<div
			bind:this={element}
			class="min-h-[400px] cursor-text rounded-lg border border-slate-200 bg-white dark:border-slate-800 dark:bg-slate-950"
		></div>

		<!-- Command Palette -->
		{#if commandPaletteOpen}
			<div
				class="fixed z-50"
				style="left: {commandPalettePosition.x}px; top: {commandPalettePosition.y}px;"
			>
				<CommandPalette
					items={slashCommands}
					onOpenChange={(open) => {
						commandPaletteOpen = open;
						if (!open) {
							// Return focus to editor when palette closes
							editor?.chain().focus().run();
						}
					}}
					on:select={handleSlashCommandSelect}
				/>
			</div>
		{/if}
	</div>
</div>

<style>
	/* Custom styles for the editor */
</style>
