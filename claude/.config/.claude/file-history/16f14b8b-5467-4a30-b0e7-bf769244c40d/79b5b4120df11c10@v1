<script lang="ts">
  import { Button } from "@/components/ui/button";
  import Checkbox from "@/components/ui/checkbox/checkbox.svelte";
  import * as Field from "@/components/ui/field";
  import Input from "@/components/ui/input/input.svelte";
  import {
    getAnonymousDataCount,
    migrateAnonymousDataToLoggedIn,
  } from "@/db/client";
  import { createFormHelper } from "@/hooks/form-helpers.svelte";
  import { tryPromise } from "@julian-i/try-error";
  import {
    ArrowRight,
    CheckCircle,
    Database,
    Info,
    Loader2,
  } from "@lucide/svelte";
  import { onMount } from "svelte";
  import { z } from "zod";

  interface Props {
    email: string;
    checkoutId: string;
  }

  const { email, checkoutId }: Props = $props();

  const accountSchema = z
    .object({
      name: z.string().min(2, "Name must be at least 2 characters"),
      password: z.string().min(8, "Password must be at least 8 characters"),
      confirmPassword: z.string(),
    })
    .refine((data) => data.password === data.confirmPassword, {
      message: "Passwords don't match",
      path: ["confirmPassword"],
    });

  let formEl: HTMLFormElement | null = $state(null);
  let isLoading = $state(false);
  let isSuccess = $state(false);
  let errorMessage = $state<string | null>(null);
  let anonymousDataCount = $state(0);
  let migrateData = $state(false);
  let showDataMigrationOption = $state(false);

  const formHelper = createFormHelper(accountSchema);

  onMount(async () => {
    // Check if there's any anonymous data to migrate
    anonymousDataCount = await getAnonymousDataCount();
    showDataMigrationOption = anonymousDataCount > 0;
  });

  async function handleCreateAccount() {
    if (!formEl) return;

    const formData = new FormData(formEl);
    const name = formData.get("name") as string;
    const password = formData.get("password") as string;
    const confirmPassword = formData.get("confirmPassword") as string;

    const validationData = { name, password, confirmPassword };

    // Validate all fields
    Object.entries(validationData).forEach(([key, value]) => {
      formHelper.validateField(key as keyof typeof validationData, value);
    });

    if (Object.keys(formHelper.errors).length > 0) return;

    isLoading = true;
    errorMessage = null;

    try {
      const [result, error] = await tryPromise(
        fetch("/api/auth/complete-signup", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            email,
            name,
            password,
            checkoutId,
            migrateData,
          }),
        })
      );

      if (error) {
        console.error("Account creation API error:", error);
        throw error;
      }

      if (!result.ok) {
        const errorData = await result.json();
        console.error("Account creation result error:", errorData);
        errorMessage = errorData.error || "Failed to create account";
        return;
      }

      const data = await result.json();
      console.log("Account created successfully:", data);

      // Handle data migration if requested
      if (migrateData && anonymousDataCount > 0) {
        console.log("Migrating anonymous data to logged-in account...");
        const migrationResult = await migrateAnonymousDataToLoggedIn();

        if (migrationResult.success) {
          console.log(
            `Successfully migrated ${migrationResult.migratedCount} items`
          );
        } else {
          console.error("Data migration failed:", migrationResult.error);
          // Don't fail the whole process, just log the error
        }
      }

      isSuccess = true;

      // Redirect to profile after a short delay
      setTimeout(() => {
        window.location.href = "/profile";
      }, 2000);
    } catch (error) {
      console.error("Account creation error:", error);
      errorMessage = "An unexpected error occurred. Please try again.";
    } finally {
      isLoading = false;
    }
  }
</script>

{#if isSuccess}
  <div
    class="flex flex-col items-center space-y-4 p-8 bg-green-950/20 border border-green-500/20 rounded-lg"
  >
    <CheckCircle class="w-16 h-16 text-green-500" />
    <h2 class="text-2xl font-semibold text-white">
      Account Created Successfully!
    </h2>
    <p class="text-slate-300 text-center">
      Your account has been created and linked to your subscription. Redirecting
      you to your profile...
    </p>
  </div>
{:else}
  <div class="max-w-md mx-auto space-y-6">
    <div class="text-center space-y-2">
      <h2 class="text-2xl font-semibold text-white">Complete Your Account</h2>
      <p class="text-slate-300">
        Your subscription is active! Create your account to access all premium
        features.
      </p>
      <p class="text-sm text-slate-400">
        Email: <span class="text-white font-medium">{email}</span>
      </p>
    </div>

    <form bind:this={formEl} class="space-y-4">
      <Field.Field>
        <Field.Label for="name">Full Name</Field.Label>
        <Input
          id="name"
          name="name"
          type="text"
          placeholder="Enter your full name"
          required
          oninput={(e) =>
            formHelper.validateField("name", e.currentTarget.value)}
        />
        {#if formHelper.errors.name}
          <Field.Description class="text-red-500">
            {formHelper.errors.name}
          </Field.Description>
        {/if}
      </Field.Field>

      <Field.Field>
        <Field.Label for="password">Password</Field.Label>
        <Input
          id="password"
          name="password"
          type="password"
          placeholder="Choose a secure password"
          required
          oninput={(e) =>
            formHelper.validateField("password", e.currentTarget.value)}
        />
        {#if formHelper.errors.password}
          <Field.Description class="text-red-500">
            {formHelper.errors.password}
          </Field.Description>
        {/if}
      </Field.Field>

      <Field.Field>
        <Field.Label for="confirmPassword">Confirm Password</Field.Label>
        <Input
          id="confirmPassword"
          name="confirmPassword"
          type="password"
          placeholder="Confirm your password"
          required
          oninput={(e) =>
            formHelper.validateField("confirmPassword", e.currentTarget.value)}
        />
        {#if formHelper.errors.confirmPassword}
          <Field.Description class="text-red-500">
            {formHelper.errors.confirmPassword}
          </Field.Description>
        {/if}
      </Field.Field>

      {#if showDataMigrationOption}
        <div
          class="space-y-3 p-4 bg-slate-800/30 border border-slate-700/50 rounded-lg"
        >
          <div class="flex items-start space-x-3">
            <Info class="w-5 h-5 text-blue-400 mt-0.5 flex-shrink-0" />
            <div class="flex-1 space-y-2">
              <h4 class="text-sm font-medium text-white">
                Anonymous Data Found
              </h4>
              <p class="text-sm text-slate-300">
                We found {anonymousDataCount} QR scan{anonymousDataCount === 1
                  ? ""
                  : "s"} in your anonymous session.
              </p>
              <div class="flex items-center space-x-3">
                <Checkbox bind:checked={migrateData} id="migrate-data" />
                <label
                  for="migrate-data"
                  class="text-sm text-slate-200 cursor-pointer"
                >
                  <span class="flex items-center space-x-2">
                    <Database class="w-4 h-4" />
                    <span>Transfer this data to my new account</span>
                  </span>
                </label>
              </div>
              <div class="text-xs text-slate-400 mt-2">
                {#if migrateData}
                  <div class="flex items-center space-x-1 text-green-400">
                    <ArrowRight class="w-3 h-3" />
                    <span
                      >Data will be transferred to your logged-in account</span
                    >
                  </div>
                {:else}
                  <div class="flex items-center space-x-1">
                    <Database class="w-3 h-3" />
                    <span
                      >Data will remain in anonymous storage (separate from your
                      account)</span
                    >
                  </div>
                {/if}
              </div>
            </div>
          </div>
        </div>
      {/if}

      {#if errorMessage}
        <div
          class="p-3 bg-red-950/20 border border-red-500/20 rounded text-red-400 text-sm"
        >
          {errorMessage}
        </div>
      {/if}

      <Button
        onclick={handleCreateAccount}
        type="button"
        variant="default"
        class="w-full"
        disabled={isLoading}
      >
        {#if isLoading}
          <Loader2 class="w-4 h-4 animate-spin mr-2" />
        {/if}
        Create Account
      </Button>
    </form>

    <p class="text-xs text-slate-400 text-center">
      By creating an account, you agree to our Terms of Service and Privacy
      Policy.
    </p>
  </div>
{/if}
