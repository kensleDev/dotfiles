import { getDatabase, type Scan } from "@/db/client";
import type { ScanDisplay } from "@/types";
import { liveQuery } from "dexie";
import { toast } from "svelte-sonner";
import { authClient } from "@/auth/auth.client";
import { generateQRCode } from "./scans.service.svelte";
import { isShortlink, shortlinkDomain } from "./shortlinks/detect";

// Get the appropriate database instance based on auth state
async function getDb() {
  const session = await authClient.getSession();
  const isLoggedIn = session.data !== null;
  return getDatabase(isLoggedIn);
}

// Reactive query that returns scans ordered by created_at DESC
/**
 * Augment a scan with computed shortlink properties
 */
function augmentScanWithShortlinkData(scan: Scan) {
  const isShortlinkContent = isShortlink(scan.data);

  return {
    ...scan,
    isShortlink: isShortlinkContent,
    shortlinkDomain: shortlinkDomain(scan.data),
    // For shortlinks, initially set expanded state to false
    // This ensures shortlinks show as "warning" initially until expansion is complete
    shortlinkExpanded: isShortlinkContent ? false : undefined,
  };
}

export function getScans() {
  return liveQuery(async () => {
    const db = await getDb();
    const scans = await db.scans.orderBy("created_at").reverse().toArray();

    // Augment each scan with shortlink detection
    const augmentedScans = scans.map(augmentScanWithShortlinkData);

    return {
      results: augmentedScans,
      fetching: false,
      error: null,
    };
  });
}

async function addScan(data: string, isSafe: boolean): Promise<ScanDisplay> {
  console.log("ðŸ’¾ Adding scan:", {
    data,
    length: data.length,
    charCodes: data.split('').map(c => c.charCodeAt(0)),
    isSafe
  });

  const qrcode = await generateQRCode(data);

  const scan: Scan = {
    id: self.crypto.randomUUID(),
    data,
    qrcode,
    created_at: new Date(),
    visited: false,
    isSafe,
  };

  const db = await getDb();
  const id = await db.scans.add(scan);
  console.log("ðŸ’¾ Scan added to DB:", { id, scan });

  // Return augmented scan with shortlink data
  return augmentScanWithShortlinkData(scan) as unknown as ScanDisplay;
}

async function deleteScan(id: string) {
  try {
    const db = await getDb();
    await db.scans.delete(id);
    console.log({ deleted: id });
    toast.success("Scan deleted successfully");
    return true;
  } catch (error) {
    toast.error("There was a problem deleting the scan");
    console.log(error);
    return false;
  }
}

async function markScanAsVisited(id: string) {
  try {
    const db = await getDb();
    await db.scans.update(id, { visited: true });
    console.log({ updated: id });
    return id;
  } catch (error) {
    console.log({ error });
  }
}

async function getScanById(id: string) {
  try {
    const db = await getDb();
    const scan = await db.scans.get(id);
    if (scan) {
      // Return augmented scan with shortlink data
      return augmentScanWithShortlinkData(scan);
    }
    return null;
  } catch (error) {
    console.error("Error fetching scan by ID:", error);
    return null;
  }
}

export const scanRepo: ScanRepo = {
  addScan,
  deleteScan,
  markScanAsVisited,
  getScanById,
};

export interface ScanRepo {
  addScan: typeof addScan;
  deleteScan: typeof deleteScan;
  markScanAsVisited: typeof markScanAsVisited;
  getScanById: typeof getScanById;
}
