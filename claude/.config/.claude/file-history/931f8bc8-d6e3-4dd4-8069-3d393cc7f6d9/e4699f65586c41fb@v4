<script lang="ts">
  import { authClient } from "@/auth/auth.client";
  import Button from "@/components/ui/button/button.svelte";
  import * as Field from "@/components/ui/field";
  import Input from "@/components/ui/input/input.svelte";
  import { tryPromise } from "@julian-i/try-error";
  import { IconBrandGithub, IconBrandGoogle } from "@tabler/icons-svelte";
  import { ZodError } from "zod";
  import { signupFormSchema } from "./schema";

  let formEl: HTMLFormElement | null = null;

  // Field-specific error state
  let errors = $state<Record<string, string>>({});

  // Track which fields have been touched by the user
  let touched = $state<Record<string, boolean>>({});

  // Validate a single field
  function validateField(fieldName: string, value: string) {
    // Mark field as touched
    touched[fieldName] = true;

    // Get the field schema
    const fieldSchema = signupFormSchema.shape[fieldName as keyof typeof signupFormSchema.shape];

    if (fieldSchema) {
      const result = fieldSchema.safeParse(value);

      if (result.success) {
        // Remove error if validation passes
        const { [fieldName]: _, ...rest } = errors;
        errors = rest;
      } else {
        // Set error if validation fails (only if field has been touched)
        if (touched[fieldName]) {
          errors[fieldName] = result.error.errors[0].message;
        }
      }
    }
  }

  async function signUpWithEmail() {
    // Clear previous errors
    errors = {};

    const formData = new FormData(formEl!);

    const data = {
      name: formData.get("name"),
      email: formData.get("email"),
      password: formData.get("password"),
    };

    const [parsed, parseError] = await tryPromise(
      signupFormSchema.parseAsync(data)
    );

    if (parseError) {
      console.error("Parsing error:", parseError);

      // Map Zod errors to field-specific errors
      if (parseError instanceof ZodError) {
        console.log({ parseError });
        parseError.issues.forEach((error) => {
          const field = error.path[0] as string;
          errors[field] = error.message;
        });
      }

      console.log({ errors });
      return;
    }

    const [signUpResult, signUpError] = await tryPromise(
      authClient.signUp.email(parsed)
    );

    if (signUpError) {
      console.error("Sign up error:", signUpError);
      return;
    }

    console.log("Sign up successful:", signUpResult);
  }
</script>

<div class="flex h-screen items-center justify-center">
  <div class="flex flex-col gap-8 rounded-xl border border-slate-500 p-14">
    <form class="flex flex-col gap-6" bind:this={formEl}>
      <Field.Field class="mb-6">
        <Field.Label for="name">Name</Field.Label>
        <Input
          id="name"
          name="name"
          type="text"
          placeholder="Your name"
          oninput={(e) => validateField("name", e.currentTarget.value)}
        />
        {#if errors.name}
          <Field.Description class="text-red-500"
            >{errors.name}</Field.Description
          >
        {/if}
      </Field.Field>

      <Field.Field class="mb-6">
        <Field.Label for="email">Email</Field.Label>
        <Input
          id="email"
          name="email"
          type="email"
          placeholder="you@example.com"
          oninput={(e) => validateField("email", e.currentTarget.value)}
        />
        {#if errors.email}
          <Field.Description class="text-red-500"
            >{errors.email}</Field.Description
          >
        {/if}
      </Field.Field>

      <Field.Field class="mb-6">
        <Field.Label for="password">Password</Field.Label>
        <Input
          id="password"
          name="password"
          type="password"
          placeholder="Your password"
          oninput={(e) => validateField("password", e.currentTarget.value)}
        />
        {#if errors.password}
          <Field.Description class="text-red-500"
            >{errors.password}</Field.Description
          >
        {/if}
      </Field.Field>

      <Button type="button" onclick={() => signUpWithEmail()}>Sign Up</Button>
    </form>

    <hr class="flex-1 border-slate-500" />

    <div class="flex gap-4">
      <button
        onclick={async () => {
          await authClient.signIn.social({
            provider: "google",
          });
        }}
        class="flex gap-3 rounded-full border border-slate-500 p-6"
      >
        <IconBrandGoogle />
        <p>Sign up with Google</p>
      </button>

      <button
        onclick={async () => {
          await authClient.signIn.social({
            provider: "github",
          });
        }}
        class="flex gap-3 rounded-full border border-slate-500 p-6"
      >
        <IconBrandGithub />
        <p>Sign up with GitHub</p>
      </button>
    </div>
  </div>
</div>
