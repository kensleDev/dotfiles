<script lang="ts">
  import { authClient } from "@/auth/auth.client";
  import Button from "@/components/ui/button/button.svelte";
  import * as Field from "@/components/ui/field";
  import Input from "@/components/ui/input/input.svelte";
  import { createFormHelper } from "@/hooks/form-helpers.svelte";
  import { tryPromise } from "@julian-i/try-error";
  import { IconBrandGithub, IconBrandGoogle } from "@tabler/icons-svelte";
  import { signupFormSchema } from "./schema";

  let formEl: HTMLFormElement | null = null;

  // Create form helper with validation logic
  const formHelper = createFormHelper(signupFormSchema);

  async function signUpWithEmail() {
    const formData = new FormData(formEl!);

    const data = {
      name: formData.get("name"),
      email: formData.get("email"),
      password: formData.get("password"),
    };

    // Validate all fields
    const isValid = formHelper.validateAllFields(data);

    if (!isValid) {
      console.error("Validation failed:", formHelper.errors);
      return;
    }

    const [parsed, parseError] = await tryPromise(
      signupFormSchema.parseAsync(data)
    );

    if (parseError) {
      console.error("Parsing error:", parseError);
      return;
    }

    const [signUpResult, signUpError] = await tryPromise(
      authClient.signUp.email(parsed)
    );

    if (signUpError) {
      console.error("Sign up error:", signUpError);
      return;
    }

    console.log("Sign up successful:", signUpResult);
  }
</script>

<div class="flex h-screen items-center justify-center">
  <div class="flex flex-col gap-8 rounded-xl border border-slate-500 p-14">
    <form class="flex flex-col gap-6" bind:this={formEl}>
      <Field.Field class="mb-6">
        <Field.Label for="name">Name</Field.Label>
        <Input
          id="name"
          name="name"
          type="text"
          placeholder="Your name"
          oninput={(e) => formHelper.validateField("name", e.currentTarget.value)}
        />
        {#if formHelper.errors.name}
          <Field.Description class="text-red-500"
            >{formHelper.errors.name}</Field.Description
          >
        {/if}
      </Field.Field>

      <Field.Field class="mb-6">
        <Field.Label for="email">Email</Field.Label>
        <Input
          id="email"
          name="email"
          type="email"
          placeholder="you@example.com"
          oninput={(e) => formHelper.validateField("email", e.currentTarget.value)}
        />
        {#if formHelper.errors.email}
          <Field.Description class="text-red-500"
            >{formHelper.errors.email}</Field.Description
          >
        {/if}
      </Field.Field>

      <Field.Field class="mb-6">
        <Field.Label for="password">Password</Field.Label>
        <Input
          id="password"
          name="password"
          type="password"
          placeholder="Your password"
          oninput={(e) => formHelper.validateField("password", e.currentTarget.value)}
        />
        {#if formHelper.errors.password}
          <Field.Description class="text-red-500"
            >{formHelper.errors.password}</Field.Description
          >
        {/if}
      </Field.Field>

      <Button type="button" onclick={() => signUpWithEmail()}>Sign Up</Button>
    </form>

    <hr class="flex-1 border-slate-500" />

    <div class="flex gap-4">
      <button
        onclick={async () => {
          await authClient.signIn.social({
            provider: "google",
          });
        }}
        class="flex gap-3 rounded-full border border-slate-500 p-6"
      >
        <IconBrandGoogle />
        <p>Sign up with Google</p>
      </button>

      <button
        onclick={async () => {
          await authClient.signIn.social({
            provider: "github",
          });
        }}
        class="flex gap-3 rounded-full border border-slate-500 p-6"
      >
        <IconBrandGithub />
        <p>Sign up with GitHub</p>
      </button>
    </div>
  </div>
</div>
