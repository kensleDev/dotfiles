<script lang="ts">
  import Button from "@/components/ui/button/button.svelte";
  import * as Field from "@/components/ui/field";
  import Input from "@/components/ui/input/input.svelte";
  import { getAnonymousDataCount } from "@/db/client";
  import { createFormHelper } from "@/hooks/form-helpers.svelte";
  import { CheckCircle } from "@lucide/svelte";
  import { onMount } from "svelte";
  import { z } from "zod";
  import { completeSignupRemote } from "../completeSignup.remote";
  import MigrateDataOption from "./MigrateDataOption.svelte";

  interface Props {
    email: string;
    checkoutId: string;
  }

  const { email, checkoutId }: Props = $props();

  const accountSchema = z
    .object({
      name: z.string().min(2, "Name must be at least 2 characters"),
      password: z.string().min(8, "Password must be at least 8 characters"),
      confirmPassword: z.string(),
    })
    .refine((data) => data.password === data.confirmPassword, {
      message: "Passwords don't match",
      path: ["confirmPassword"],
    });

  let formEl: HTMLFormElement | null = $state(null);
  let isLoading = $state(false);
  let isSuccess = $state(false);
  let errorMessage = $state<string | null>(null);
  let anonymousDataCount = $state(0);
  let migrateData = $state(false);
  let showDataMigrationOption = $state(false);

  const formHelper = createFormHelper(accountSchema);

  onMount(async () => {
    // Check if there's any anonymous data to migrate
    anonymousDataCount = await getAnonymousDataCount();
    showDataMigrationOption = anonymousDataCount > 0;
  });
</script>

{#if isSuccess}
  <div
    class="flex flex-col items-center space-y-4 p-8 bg-green-950/20 border border-green-500/20 rounded-lg"
  >
    <CheckCircle class="w-16 h-16 text-green-500" />
    <h2 class="text-2xl font-semibold text-white">
      Account Created Successfully!
    </h2>
    <p class="text-slate-300 text-center">
      Your account has been created and linked to your subscription. Redirecting
      you to your profile...
    </p>
  </div>
{:else}
  <div class="max-w-md mx-auto space-y-6">
    <div class="text-center space-y-2">
      <h2 class="text-2xl font-semibold text-white">Complete Your Account</h2>
      <p class="text-slate-300">
        Your subscription is active! Create your account to access all premium
        features.
      </p>
      <p class="text-sm text-slate-400">
        Email: <span class="text-white font-medium">{email}</span>
      </p>
    </div>

    <form {...completeSignupRemote} class="space-y-8">
      <input type="hidden" name="email" value={email} />

      <Field.Field>
        <Field.Label for="name">Full Name</Field.Label>
        <Input
          id="name"
          name="name"
          type="text"
          placeholder="Enter your full name"
          required
          oninput={(e) =>
            formHelper.validateField("name", e.currentTarget.value)}
        />
        {#if formHelper.errors.name}
          <Field.Description class="text-red-500">
            {formHelper.errors.name}
          </Field.Description>
        {/if}
      </Field.Field>

      <Field.Field>
        <Field.Label for="password">Password</Field.Label>
        <Input
          id="password"
          name="password"
          type="password"
          placeholder="Choose a secure password"
          required
          oninput={(e) =>
            formHelper.validateField("password", e.currentTarget.value)}
        />
        {#if formHelper.errors.password}
          <Field.Description class="text-red-500">
            {formHelper.errors.password}
          </Field.Description>
        {/if}
      </Field.Field>

      <Field.Field>
        <Field.Label for="confirmPassword">Confirm Password</Field.Label>
        <Input
          id="confirmPassword"
          name="confirmPassword"
          type="password"
          placeholder="Confirm your password"
          required
          oninput={(e) =>
            formHelper.validateField("confirmPassword", e.currentTarget.value)}
        />
        {#if formHelper.errors.confirmPassword}
          <Field.Description class="text-red-500">
            {formHelper.errors.confirmPassword}
          </Field.Description>
        {/if}
      </Field.Field>

      <MigrateDataOption bind:migrateData />

      <input type="hidden" name="checkoutId" value={checkoutId} />

      {#if errorMessage}
        <div
          class="p-3 bg-red-950/20 border border-red-500/20 rounded text-red-400 text-sm"
        >
          {errorMessage}
        </div>
      {/if}

      <Button type="submit">Submit</Button>
    </form>

    <p class="text-xs text-slate-400 text-center">
      By creating an account, you agree to our Terms of Service and Privacy
      Policy.
    </p>
  </div>
{/if}
