<!-- src/routes/(app)/org/[orgId]/w/[pageId]/+page.svelte -->
<script lang="ts">
	import { goto } from '$app/navigation';
	import { resolve } from '$app/paths';
	import { page } from '$app/stores';
	import { DEFAULT_WORKSPACE_ID } from '@/constants/workspace';
	import {
		createBlankPage,
		deletePage,
		updatePageTitle,
		upsertPage
	} from '@/db/client/repos/page.repo.svelte';
	import type { Page } from '@/db/client/triplit/schema';
	import Breadcrumbs from '@/features/editor/Breadcrumbs.svelte';
	import EditorToolbarMobile from '@/features/editor/components/EditorToolbarMobile.svelte';
	import PageSettingsDialog, {
		pageSettingsDialog
	} from '@/features/editor/dialogs/PageSettingsDialog.svelte';

	import Editor from '@/features/editor/Editor.svelte';
	import EditorControls from '@/features/editor/EditorControls.svelte';

	import { authStore } from '@/state/auth.store.svelte';
	import { editorStore } from '@/state/editor.store.svelte';
	import { pagesStore } from '@/state/pages.store.svelte';

	import { debounce } from '@/utils/debounce';
	import { getBreadcrumbs } from '@/utils/getBreadcrumbs';
	import type { Editor as TiptapEditor } from '@tiptap/core';

	let { data } = $props();

	let pageId = $derived($page.url.searchParams.get('pg'));
	let pageData = $derived(pagesStore.getFullPage(pageId ?? ''));
	let breadcrumbs = $derived(getBreadcrumbs(pageId ?? '', pagesStore.pagesWithoutContent));
	let currentPage = $state<Page | null>(null);
	let editor = $state<TiptapEditor | undefined>(undefined);

	// Sync editor instance to store for use in layout
	$effect(() => {
		editorStore.setEditor(editor);
	});

	$effect(() => {
		if (pageData) {
			pageData.then((p) => {
				currentPage = p as unknown as Page;
				console.log('EDIOR_PAGE', { currentPage });
			});
		}
	});

	async function handleTitleChange(pageId: string, title: string) {
		// Update local state immediately for instant UI feedback
		if (currentPage) {
			currentPage.title = title;
		}

		await updatePageTitle(pageId, title);
		await pagesStore.refetchPagesWithoutContent();
	}
	const debouncedHandleTitleChange = debounce(handleTitleChange, 500);

	async function handleContentChange(
		content: string,
		userId: string,
		workspaceId: string,
		orgId: string
	) {
		await upsertPage(pageId ?? '', content, orgId, userId, workspaceId);
	}
	const debouncedHandleContentChange = debounce(handleContentChange, 500);

	async function handleDeletePage(pageId: string) {
		await deletePage(pageId);
		await pagesStore.refetchPagesWithoutContent();
		goto(resolve(`/home`));
	}

	import AppDialogs from '@/features/shell/AppDialogs.svelte';
	import { dialogsStore } from '@/state/dialogs.store.svelte.js';
	import { keyboardViewport } from '@/utils/keyboardViewport.svelte';

	const { isMobile, keyboardOpen } = keyboardViewport({ debug: true });

	// Debug logging
	$effect(() => {
		console.log('Keyboard viewport state:', { isMobile, keyboardOpen });
	});

	// Handle new page creation
	async function handleNewPageSubmit(data: { title: string; parentPageId?: string }) {
		const { title, parentPageId } = data;
		console.log('Creating new page:', { title, parentPageId });

		try {
			if (!title?.trim()) return;
			const newPage = await createBlankPage(
				authStore.user?.id ?? '',
				authStore.member?.orgId ?? '',
				title.trim(),
				parentPageId ?? '',
				''
			);
			const url = `/e?pg=${newPage.id}&workspaceId=${DEFAULT_WORKSPACE_ID}`;
			goto(resolve(url));
			await pagesStore.refetchPagesWithoutContent();
		} catch (error) {
			console.error({ error });
		}

		dialogsStore.newPageDialog.close();
		dialogsStore.resetNewPageContext();
	}
</script>

<!-- <PageEditor {pageId} {orgId} {currentUser} /> -->

{#await pageData then page}
	{@const currentPageData = page as unknown as Page | null}
	{#if currentPageData}
		<div
			class="page-header fixed z-50 flex h-[40px] w-full items-center gap-4 bg-background px-3 pt-2 pb-2"
		>
			<div class="min-w-0 flex-1">
				<Breadcrumbs {breadcrumbs} />
			</div>

			<EditorControls {editor} {pageSettingsDialog} {currentPage} />
		</div>

		<div
			class="grid min-h-[calc(100vh-40px)] w-full grid-cols-[1fr_minmax(280px,min(85vw,1200px))_1fr] pt-20"
		>
			<div class="col-start-2 col-end-3 w-full pb-12 md:px-5">
				<Editor
					title={currentPageData.title ?? 'Untitled'}
					content={currentPageData.content}
					onContentChange={(content) =>
						debouncedHandleContentChange(
							content,
							data.user?.authUser?.id ?? '',
							currentPageData?.workspaceId ?? DEFAULT_WORKSPACE_ID,
							String(data.user?.member?.orgId ?? '')
						)}
					onContentChangeImmediate={async (content) =>
						handleContentChange(
							content,
							data.user?.authUser?.id ?? '',
							currentPageData?.workspaceId ?? DEFAULT_WORKSPACE_ID,
							String(data.user?.member?.orgId ?? '')
						)}
					onTitleChange={(e) => debouncedHandleTitleChange(pageId ?? '', e)}
					parentPageId={pageId ?? ''}
					bind:editorInstance={editor}
				/>
			</div>
		</div>

		{#if isMobile && keyboardOpen}
			<EditorToolbarMobile
				class="fixed bottom-0 left-0 w-full bg-background px-2 shadow-xl"
				editor={editor!}
			/>
		{/if}

		<PageSettingsDialog
			pageId={pageId ?? ''}
			initialPageTitle={currentPageData.title}
			onRename={({ pageId, newTitle }) => debouncedHandleTitleChange(pageId, newTitle)}
			onDelete={async (pageId: string) => handleDeletePage(pageId)}
		/>

		<AppDialogs
			workspaceId={DEFAULT_WORKSPACE_ID}
			orgId={String(authStore.member?.orgId || '')}
			userId={authStore.user?.id || ''}
			onSubmit={handleNewPageSubmit}
		/>
	{:else}
		<div class="flex h-full items-center justify-center">
			<p class="text-gray-500">Loading page...</p>
		</div>
	{/if}
{/await}
