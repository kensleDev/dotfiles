<script lang="ts">
	import { goto } from '$app/navigation';
	import { resolve } from '$app/paths';
	import { createBlankPage } from '@/db/client/repos/page.repo.svelte';
	import { authStore } from '@/state/auth.store.svelte';
	import { dialogsStore } from '@/state/dialogs.store.svelte';
	import { pagesStore } from '@/state/pages.store.svelte';
	import LinkDialog from '../editor/dialogs/LinkDialog.svelte';
	import NewPageDialog from '../editor/dialogs/NewPageDialog.svelte';
	import type { ImportResult } from '../editor/import/markdownImport.service';
	import MarkdownImportDialog from '../editor/import/MarkdownImportDialog.svelte';

	let { workspaceId, orgId, userId } = $props();

	// Markdown import handler
	function handleImportComplete(result: ImportResult) {
		console.log('Import completed:', result);
		void pagesStore.refetchPagesWithoutContent();
	}

	// New page handler
	async function handleNewPageSubmit(data: { title: string; parentPageId?: string }) {
		const { title, parentPageId } = data;

		// Create a blank page with just the title
		const newPage = await createBlankPage(
			authStore.user?.id ?? '',
			authStore.member?.orgId ?? '',
			title,
			parentPageId,
			''
		);
		await pagesStore.refetchPagesWithoutContent();

		// Navigate to the new page
		goto(resolve(`/e?pg=${newPage.id}`));
	}

	// Link dialog handler
	function handleLinkSubmit(data: {
		url: string;
		text: string;
		type: 'internal' | 'external';
		pageId?: string;
	}) {
		// Use the registered editor callback if available
		if (dialogsStore.editorLinkCallback) {
			dialogsStore.editorLinkCallback(data);
		} else {
			// If no editor callback, just navigate to internal links
			if (data.type === 'internal' && data.pageId) {
				goto(resolve(`/e?pg=${data.pageId}`));
			}
		}
	}
</script>

<MarkdownImportDialog {workspaceId} {orgId} {userId} onComplete={handleImportComplete} />
<NewPageDialog onSubmit={handleNewPageSubmit} />
<LinkDialog onSubmit={handleLinkSubmit} />
