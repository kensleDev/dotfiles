import * as fs from 'fs';
import * as path from 'path';
import { Challenge } from '../types';
import { createDir, writeFile } from '../types/GameState';

// Import utilities from separate module to avoid circular dependency
export function clearScreen() {
  console.log('\x1Bc');
}

export function formatDuration(ms: number): string {
  const seconds = Math.floor(ms / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);

  if (hours > 0) {
    return `${hours}h ${minutes % 60}m`;
  } else if (minutes > 0) {
    return `${minutes}m ${seconds % 60}s`;
  } else {
    return `${seconds}s`;
  }
}

export function setupChallengeEnvironment(challenge: Challenge) {
  // Create game directory if it doesn't exist
  const gameDir = path.join(process.cwd(), '.cli-quest-game');
  createDir(gameDir);

  // Call the challenge's setup function
  try {
    challenge.setup();
  } catch (error) {
    console.error(`Setup error for challenge ${challenge.id}: ${error}`);
  }
}

export function cleanupEnvironment() {
  const gameDir = path.join(process.cwd(), '.cli-quest-game');
  if (fs.existsSync(gameDir)) {
    fs.rmSync(gameDir, { recursive: true, force: true });
  }
}

export function setupFdChallenge1() {
  // Create a realistic SvelteKit project structure
  writeFile(path.join(process.cwd(), '.cli-quest-game/project/src/routes/+page.svelte'), `<script lang="ts">
  // TODO: Add loading state
  let count = 0;
</script>

<h1>Welcome</h1>
<!-- TODO: Add footer -->`);

  writeFile(path.join(process.cwd(), '.cli-quest-game/project/src/routes/api/users/+server.ts'), `// TODO: Add authentication
export async function GET() {
  // TODO: Implement pagination
  return new Response('Users');
}`);

  writeFile(path.join(process.cwd(), '.cli-quest-game/project/src/lib/utils.ts'), `// TODO: Add error handling
export function formatDate(date: Date) {
  return date.toISOString();
}

// TODO: Add tests`);

  writeFile(path.join(process.cwd(), '.cli-quest-game/project/src/lib/components/Header.svelte'), `<script>
  // TODO: Add mobile menu
</script>

<header>
  <!-- TODO: Add logo -->
  <nav>Nav</nav>
</header>`);

  writeFile(path.join(process.cwd(), '.cli-quest-game/project/README.md'), `# My Project

TODO: Write better docs`);
}

export function setupSedChallenge1() {
  writeFile(path.join(process.cwd(), '.cli-quest-game/project/src/routes/+page.ts'), `import { Button } from '@/components/old/Button';
import { Card } from '@/components/old/Card';

export function load() {
  return { title: 'Home' };
}`);

  writeFile(path.join(process.cwd(), '.cli-quest-game/project/src/lib/utils.ts'), `import { Dialog } from '@/components/old/Dialog';

export function showDialog() {
  // Implementation
}`);

  writeFile(path.join(process.cwd(), '.cli-quest-game/project/src/lib/helpers.ts'), `import { Input } from '@/components/old/Input';
import { Form } from '@/components/old/Form';

export const helpers = {};`);
}

// Add more setup functions for other challenges as needed