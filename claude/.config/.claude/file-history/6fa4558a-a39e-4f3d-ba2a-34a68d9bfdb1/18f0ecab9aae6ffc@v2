import { Challenge } from '../..';
import * as fs from 'fs';
import * as path from 'path';

export const challenge4: Challenge = {
  id: 'sed-4',
  title: "Backup and Replace",
  tool: 'sed',
  story: `ðŸ’¾ Database Migration Script

You need to migrate old database schema references. First create backups, then replace all instances.

Your task: Use sed to create backup files (.bak) for all SQL files, then replace old table names:
- 'users_old' â†’ 'users_new'
- 'posts_old' â†’ 'posts_new'

Source: .cli-quest-game/database/`,

  setup: () => {
    // This will be handled by the game runner
  },

  validation: () => {
    const files = [
      path.join(process.cwd(), '.cli-quest-game/database/schema.sql'),
      path.join(process.cwd(), '.cli-quest-game/database/users.sql'),
      path.join(process.cwd(), '.cli-quest-game/database/posts.sql')
    ];

    return files.every(file => {
      if (!fs.existsSync(file)) return false;
      const content = fs.readFileSync(file, 'utf-8');
      return content.includes('users_new') &&
             content.includes('posts_new') &&
             fs.existsSync(file + '.bak');
    });
  },

  hints: [
    "Use sed to create backup first: sed -i.bak 's/pattern/replacement/g' file",
    "Backup before editing is important!",
    "Try: find .cli-quest-game/database -name '*.sql' -exec sed -i.bak 's/users_old/users_new/g; s/posts_old/posts_new/g' {} +"
  ],

  solution: "find .cli-quest-game/database -name '*.sql' -exec sed -i.bak 's/users_old/users_new/g; s/posts_old/posts_new/g' {} +",
  difficulty: 4,
  estimatedTime: 8
};

export const challenge5: Challenge = {
  id: 'sed-5',
  title: "Pipeline Integration",
  tool: 'sed',
  story: `ðŸ”§ Complex Text Transformation

You need to process a log file and extract specific information using sed in a pipeline.

Your task: Create a pipeline that processes access.log to:
1. Extract only GET requests
2. Remove IP addresses
3. Extract URLs only
4. Count unique URLs

Save the result to 'unique-urls.txt' with URL count per line.`,

  setup: () => {
    // This will be handled by the game runner
  },

  validation: () => {
    const resultFile = path.join(process.cwd(), '.cli-quest-game/unique-urls.txt');
    if (!fs.existsSync(resultFile)) return false;

    const content = fs.readFileSync(resultFile, 'utf-8').trim();
    const lines = content.split('\n').filter(l => l.trim());

    return lines.length === 4 &&
           lines.some(line => line.includes('/api/users')) &&
           lines.some(line => line.includes('/api/posts')) &&
           lines.some(line => line.includes('/dashboard'));
  },

  hints: [
    "Use sed to filter GET requests: sed -n '/GET/p' file",
    "Remove IP addresses: sed 's/[0-9.]* //g'",
    "Extract URLs: sed 's/GET \\([^ ]*\\).*/\\1/'",
    "Try: cat .cli-quest-game/access.log | sed -n '/GET/p' | sed 's/[0-9.]* //g' | sed 's/GET \\([^ ]*\\).*/\\1/' | sort | uniq -c | sort -nr > .cli-quest-game/unique-urls.txt"
  ],

  solution: "cat .cli-quest-game/access.log | sed -n '/GET/p' | sed 's/[0-9.]* //g' | sed 's/GET \\([^ ]*\\).*/\\1/' | sort | uniq -c | sort -nr > .cli-quest-game/unique-urls.txt",
  difficulty: 5,
  estimatedTime: 10
};