import { Challenge } from '../..';
import * as fs from 'fs';
import * as path from 'path';
import { setupSedChallenge1 } from '../../game/Utils';

export const challenges: Challenge[] = [
  {
    id: 'sed-1',
    title: "The Great Migration",
    tool: 'sed',
    story: `ðŸ”„ Refactoring Time

The team decided to reorganize imports. All imports from '@/components/old'
need to be updated to '@/components/ui'.

The lead says: "We have 3 TypeScript files that need updating. Can you
do a find-and-replace across all of them?"

Your task: Use 'sed' to replace all occurrences of '@/components/old'
with '@/components/ui' in all .ts files in .cli-quest-game/project/src`,

    setup: setupSedChallenge1,

    validation: () => {
      const files = [
        path.join(process.cwd(), '.cli-quest-game/project/src/routes/+page.ts'),
        path.join(process.cwd(), '.cli-quest-game/project/src/lib/utils.ts'),
        path.join(process.cwd(), '.cli-quest-game/project/src/lib/helpers.ts')
      ];

      return files.every(file => {
        if (!fs.existsSync(file)) return false;
        const content = fs.readFileSync(file, 'utf-8');
        return !content.includes('@/components/old') &&
               content.includes('@/components/ui');
      });
    },

    hints: [
      "Use 'sed' to replace text. Basic syntax: sed 's/old/new/g' file",
      "To edit files in-place, use: sed -i 's/old/new/g' file",
      "Combine with fd: fd '.ts$' .cli-quest-game/project/src -x sed -i 's/@\\/components\\/old/@\\/components\\/ui/g' {}"
    ],

    solution: "fd '.ts$' .cli-quest-game/project/src -x sed -i 's/@\\/components\\/old/@\\/components\\/ui/g' {}",
    difficulty: 1,
    estimatedTime: 5
  },

  {
    id: 'sed-2',
    title: "Version Cleanup",
    tool: 'sed',
    story: `ðŸ—‚ï¸ API Version Update

You're updating from v1 to v2 of an API. All endpoint URLs need to be updated:
- '/api/v1/users' â†’ '/api/v2/users'
- '/api/v1/posts' â†’ '/api/v2/posts'

Your task: Use 'sed' to perform multiple replacements across all JavaScript files to update the API endpoints.

Source: .cli-quest-game/src/api`,

    setup: () => {
      // Placeholder setup - will be implemented later
    },

    validation: () => {
      const files = [
        path.join(process.cwd(), '.cli-quest-game/src/api/client.js'),
        path.join(process.cwd(), '.cli-quest-game/src/api/user.js'),
        path.join(process.cwd(), '.cli-quest-game/src/api/post.js')
      ];

      return files.every(file => {
        if (!fs.existsSync(file)) return false;
        const content = fs.readFileSync(file, 'utf-8');
        return !content.includes('/api/v1/') &&
               content.includes('/api/v2/');
      });
    },

    hints: [
      "Use multiple sed commands with -e flag",
      "Try: sed -e 's/\\/api\\/v1\\/users/\\/api\\/v2\\/users/g' -e 's/\\/api\\/v1\\/posts/\\/api\\/v2\\/posts/g' file",
      "Combine with find for multiple files: find .cli-quest-game/src/api -name '*.js' -exec sed -i -e 's/\\/api\\/v1\\/users/\\/api\\/v2\\/users/g' -e 's/\\/api\\/v1\\/posts/\\/api\\/v2\\/posts/g' {} +"
    ],

    solution: "find .cli-quest-game/src/api -name '*.js' -exec sed -i -e 's/\\/api\\/v1\\/users/\\/api\\/v2\\/users/g' -e 's/\\/api\\/v1\\/posts/\\/api\\/v2\\/posts/g' {} +",
    difficulty: 2,
    estimatedTime: 6
  },

  {
    id: 'sed-3',
    title: "CSS Variable Renaming",
    tool: 'sed',
    story: `ðŸŽ¨ Design System Update

The design team renamed CSS variables. You need to update them across all CSS files:
- '--primary-color' â†’ '--brand-primary'
- '--secondary-color' â†’ '--brand-secondary'
- '--border-radius' â†’ '--brand-radius'

Your task: Use 'sed' with regex to find and replace CSS variables in all .css files.

Source: .cli-quest-game/src/styles`,

    setup: () => {
      // Placeholder setup - will be implemented later
    },

    validation: () => {
      const files = [
        path.join(process.cwd(), '.cli-quest-game/src/styles/main.css'),
        path.join(process.cwd(), '.cli-quest-game/src/styles/components.css'),
        path.join(process.cwd(), '.cli-quest-game/src/styles/theme.css')
      ];

      return files.every(file => {
        if (!fs.existsSync(file)) return false;
        const content = fs.readFileSync(file, 'utf-8');
        return content.includes('--brand-primary') &&
               content.includes('--brand-secondary') &&
               content.includes('--brand-radius');
      });
    },

    hints: [
      "Use sed with regex to match CSS variable definitions",
      "Be careful with regex special characters",
      "Try: find .cli-quest-game/src/styles -name '*.css' -exec sed -i 's/--primary-color/--brand-primary/g; s/--secondary-color/--brand-secondary/g; s/--border-radius/--brand-radius/g' {} +"
    ],

    solution: "find .cli-quest-game/src/styles -name '*.css' -exec sed -i 's/--primary-color/--brand-primary/g; s/--secondary-color/--brand-secondary/g; s/--border-radius/--brand-radius/g' {} +",
    difficulty: 3,
    estimatedTime: 7
  },

  {
    id: 'sed-4',
    title: "Backup and Replace",
    tool: 'sed',
    story: `ðŸ’¾ Database Migration Script

You need to migrate old database schema references. First create backups, then replace all instances.

Your task: Use sed to create backup files (.bak) for all SQL files, then replace old table names:
- 'users_old' â†’ 'users_new'
- 'posts_old' â†’ 'posts_new'

Source: .cli-quest-game/database/`,

    setup: () => {
      // Placeholder setup - will be implemented later
    },

    validation: () => {
      const files = [
        path.join(process.cwd(), '.cli-quest-game/database/schema.sql'),
        path.join(process.cwd(), '.cli-quest-game/database/users.sql'),
        path.join(process.cwd(), '.cli-quest-game/database/posts.sql')
      ];

      return files.every(file => {
        if (!fs.existsSync(file)) return false;
        const content = fs.readFileSync(file, 'utf-8');
        return content.includes('users_new') &&
               content.includes('posts_new') &&
               fs.existsSync(file + '.bak');
      });
    },

    hints: [
      "Use sed to create backup first: sed -i.bak 's/pattern/replacement/g' file",
      "Backup before editing is important!",
      "Try: find .cli-quest-game/database -name '*.sql' -exec sed -i.bak 's/users_old/users_new/g; s/posts_old/posts_new/g' {} +"
    ],

    solution: "find .cli-quest-game/database -name '*.sql' -exec sed -i.bak 's/users_old/users_new/g; s/posts_old/posts_new/g' {} +",
    difficulty: 4,
    estimatedTime: 8
  },

  {
    id: 'sed-5',
    title: "Pipeline Integration",
    tool: 'sed',
    story: `ðŸ”§ Complex Text Transformation

You need to process a log file and extract specific information using sed in a pipeline.

Your task: Create a pipeline that processes access.log to:
1. Extract only GET requests
2. Remove IP addresses
3. Extract URLs only
4. Count unique URLs

Save the result to 'unique-urls.txt' with URL count per line.`,

    setup: () => {
      // Placeholder setup - will be implemented later
    },

    validation: () => {
      const resultFile = path.join(process.cwd(), '.cli-quest-game/unique-urls.txt');
      if (!fs.existsSync(resultFile)) return false;

      const content = fs.readFileSync(resultFile, 'utf-8').trim();
      const lines = content.split('\n').filter(l => l.trim());

      return lines.length === 4 &&
             lines.some(line => line.includes('/api/users')) &&
             lines.some(line => line.includes('/api/posts')) &&
             lines.some(line => line.includes('/dashboard'));
    },

    hints: [
      "Use sed to filter GET requests: sed -n '/GET/p' file",
      "Remove IP addresses: sed 's/[0-9.]* //g'",
      "Extract URLs: sed 's/GET \\([^ ]*\\).*/\\1/'",
      "Try: cat .cli-quest-game/access.log | sed -n '/GET/p' | sed 's/[0-9.]* //g' | sed 's/GET \\([^ ]*\\).*/\\1/' | sort | uniq -c | sort -nr > .cli-quest-game/unique-urls.txt"
    ],

    solution: "cat .cli-quest-game/access.log | sed -n '/GET/p' | sed 's/[0-9.]* //g' | sed 's/GET \\([^ ]*\\).*/\\1/' | sort | uniq -c | sort -nr > .cli-quest-game/unique-urls.txt",
    difficulty: 5,
    estimatedTime: 10
  }
];