import { Challenge } from '../..';
import * as fs from 'fs';
import * as path from 'path';

import { challenge4, challenge5 } from './challenge4';
import { setupFdChallenge1 } from '../../game/Utils';

export const challenges: Challenge[] = [
  {
    id: 'fd-1',
    title: "The TODO Hunt",
    tool: 'fd',
    story: `ðŸ“‹ Your First Day

You've just joined a SvelteKit project. The tech lead says:
"We have TODO comments scattered everywhere. Can you find them all?
We need a complete list before our sprint planning."

The codebase is in: .cli-quest-game/project

Your task: Use 'fd' to find all TypeScript files, then count total TODOs.
Create a file called 'todo-count.txt' with just the number.`,

    setup: setupFdChallenge1,

    validation: () => {
      const resultFile = path.join(process.cwd(), '.cli-quest-game/todo-count.txt');
      if (!fs.existsSync(resultFile)) return false;

      const content = fs.readFileSync(resultFile, 'utf-8').trim();
      // There are 8 TODOs total
      return content === '8';
    },

    hints: [
      "Use 'fd' to find files. Try: fd '.ts' to find TypeScript files",
      "You can execute commands on found files with: fd -x <command>",
      "Try: fd -e ts -e svelte -x grep -c TODO {} | awk '{sum+=$1} END{print sum}' > todo-count.txt"
    ],

    solution: "fd -e ts -e svelte -x grep -c TODO {} | awk '{sum+=$1} END{print sum}' > .cli-quest-game/todo-count.txt",
    difficulty: 1,
    estimatedTime: 5
  },

  {
    id: 'fd-2',
    title: "Hidden Configuration Files",
    tool: 'fd',
    story: `ðŸ” Configuration Discovery

You're troubleshooting a production issue. The deployment engineer says:
"We suspect there's a misconfiguration file hidden somewhere deep in the config directory."

You need to find all JSON configuration files that contain 'debug' in their filename.

Your task: Use 'fd' with regex pattern to find all JSON files with 'debug' in the name.`,

    setup: () => {
      // This will be handled by the game runner
    },

    validation: () => {
      const resultFile = path.join(process.cwd(), '.cli-quest-game/debug-files.txt');
      if (!fs.existsSync(resultFile)) return false;

      const content = fs.readFileSync(resultFile, 'utf-8').trim();
      const lines = content.split('\n').filter(l => l.trim());

      // Should find specific debug configuration files
      return lines.length === 2 && lines.some(line => line.includes('debug.json')) &&
             lines.some(line => line.includes('debug.config.json'));
    },

    hints: [
      "Use fd with pattern matching: fd --pattern 'debug'",
      "Target JSON files specifically: fd -e json --pattern 'debug'",
      "Try: fd -e json -t f --pattern 'debug' .cli-quest-game/config/ > .cli-quest-game/debug-files.txt"
    ],

    solution: "fd -e json -t f --pattern 'debug' .cli-quest-game/config/ > .cli-quest-game/debug-files.txt",
    difficulty: 2,
    estimatedTime: 5
  },

  {
    id: 'fd-3',
    title: "Test File Discovery",
    tool: 'fd',
    story: `ðŸ§ª Test Coverage Analysis

Your CI pipeline is failing. The lead developer asks:
"We need to identify which components have missing test files. Find all Svelte components that don't have corresponding test files."

Source: .cli-quest-game/src/components

Your task: Use 'fd' to find all .svelte files, then create a list of those without corresponding .test.svelte files.`,

    setup: () => {
      // This will be handled by the game runner
    },

    validation: () => {
      const resultFile = path.join(process.cwd(), '.cli-quest-game/no-tests.txt');
      if (!fs.existsSync(resultFile)) return false;

      const content = fs.readFileSync(resultFile, 'utf-8').trim();
      const lines = content.split('\n').filter(l => l.trim());

      // Should identify files without tests
      return lines.length === 3 && lines.every(line => line.endsWith('.svelte'));
    },

    hints: [
      "Use fd to find all svelte files first, then check for test files",
      "Combine fd commands: find svelte files and test files separately",
      "Try: fd -e svelte .cli-quest-game/src/components > .cli-quest-game/all-components.txt && fd -e test.svelte .cli-quest-game/src/components > .cli-quest-game/test-files.txt && comm -23 .cli-quest-game/all-components.txt <(cut -d'.' -f1-2 .cli-quest-game/test-files.txt).svelte > .cli-quest-game/no-tests.txt"
    ],

    solution: "fd -e svelte .cli-quest-game/src/components > .cli-quest-game/all-components.txt && fd -e test.svelte .cli-quest-game/src/components > .cli-quest-game/test-files.txt && comm -23 .cli-quest-game/all-components.txt <(cut -d'.' -f1-2 .cli-quest-game/test-files.txt).svelte > .cli-quest-game/no-tests.txt",
    difficulty: 3,
    estimatedTime: 8
  },
  challenge4,
  challenge5
];