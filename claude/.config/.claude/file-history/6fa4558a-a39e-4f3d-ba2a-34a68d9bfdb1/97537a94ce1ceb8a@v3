import * as readline from 'readline';
import { GameState, ToolInfo } from '../types';
import { challengesByTool, getUnlockedTools } from '../challenges';
import { clearScreen } from './Utils';

export class Display {
  private static readonly TOOLS_INFO: { [key in ToolInfo['name']]: Omit<ToolInfo, 'unlocked' | 'progress'> } = {
    fd: { name: 'fd', displayName: 'File Discovery', description: 'Find files and directories', icon: 'ðŸ”' },
    sed: { name: 'sed', displayName: 'Stream Editor', description: 'Text replacement and editing', icon: 'ðŸ“' },
    awk: { name: 'awk', displayName: 'Text Processor', description: 'Pattern scanning and processing', icon: 'ðŸ“Š' },
    jq: { name: 'jq', displayName: 'JSON Processor', description: 'Command-line JSON manipulation', icon: 'ðŸ”§' },
    rsync: { name: 'rsync', displayName: 'File Sync', description: 'Efficient file synchronization', icon: 'ðŸš€' }
  };

  static showBanner() {
    console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         CLI QUEST                             â•‘
â•‘               Master Command-Line Tools Through               â•‘
â•‘                    Real-World Challenges                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
`);
  }

  static showToolSelection(state: GameState) {
    clearScreen();
    this.showBanner();

    // Ensure toolProgress is properly initialized
    if (!state.toolProgress) {
      state.toolProgress = { fd: 0, sed: 0, awk: 0, jq: 0, rsync: 0 };
    }

    const unlockedTools = getUnlockedTools(state.toolProgress);
    const totalChallenges = Object.values(challengesByTool).flat().length;
    const completedCount = state.completedChallenges.length;
    const percentage = Math.round((completedCount / totalChallenges) * 100);

    console.log(`ðŸŽ¯ Choose your tool to continue learning\n`);
    console.log(`ðŸ“Š Overall Progress: ${completedCount}/${totalChallenges} (${percentage}%)\n`);
    console.log(`${'â”€'.repeat(65)}\n`);

    unlockedTools.forEach((tool, index) => {
      const info = this.TOOLS_INFO[tool];
      const progress = state.toolProgress[tool];
      const currentChallenges = challengesByTool[tool];

      console.log(`${index + 1}. ${info.icon} ${info.displayName}`);
      console.log(`   ${info.description}`);
      console.log(`   ðŸ“ˆ Progress: ${progress}/5 challenges completed`);

      if (progress < 5) {
        const nextChallenge = currentChallenges[progress];
        if (nextChallenge) {
          console.log(`   ðŸŽ¯ Next: ${nextChallenge.title} (Difficulty: ${'â­'.repeat(nextChallenge.difficulty)})`);
        }
      } else {
        console.log(`   âœ… All challenges completed!`);
      }
      console.log();
    });

    console.log(`Commands:`);
    console.log(`   [1-5] Select tool`);
    console.log(`   status - Show overall progress`);
    console.log(`   exit   - Save and exit`);
    console.log(`\nðŸŽ® Your turn! Choose a tool or command:\n`);
  }

  static showChallenge(challenge: any, state: GameState) {
    clearScreen();
    this.showBanner();

    const toolProgress = state.toolProgress[challenge.tool];
    const totalChallenges = Object.values(challengesByTool).flat().length;
    const completedCount = state.completedChallenges.length;
    const percentage = Math.round((completedCount / totalChallenges) * 100);

    console.log(`ðŸŽ¯ Challenge ${toolProgress}/5: ${challenge.title}`);
    console.log(`ðŸ“š Tool: ${this.TOOLS_INFO[challenge.tool].displayName}`);
    console.log(`â­ Difficulty: ${'â­'.repeat(challenge.difficulty)}`);
    console.log(`â±ï¸  Estimated time: ${challenge.estimatedTime} minutes`);
    console.log(`\n${challenge.story}`);
    console.log(`\n${'â”€'.repeat(65)}`);
    console.log(`\nðŸ’¡ Commands available:`);
    console.log(`   check    - Test your solution`);
    console.log(`   hint     - Get a hint (${3 - (state.hintsUsed[challenge.id] || 0)} remaining)`);
    console.log(`   solution - Show the solution (skips challenge)`);
    console.log(`   reset    - Reset the challenge files`);
    console.log(`   back     - Go back to tool selection`);
    console.log(`   exit     - Save and exit`);
    console.log(`\nðŸŽ® Your turn! Use any command-line tools to solve this.\n`);
  }

  static showHint(challenge: any, state: GameState) {
    const hintsShown = state.hintsUsed[challenge.id] || 0;

    if (hintsShown >= 3) {
      console.log(`\nâŒ No more hints available! Try the 'solution' command if you're stuck.\n`);
      return;
    }

    console.log(`\nðŸ’¡ Hint ${hintsShown + 1}/3:`);
    console.log(`   ${challenge.hints[hintsShown]}\n`);
  }

  static showSolution(challenge: any) {
    console.log(`\nâœ¨ Solution:`);
    console.log(`   ${challenge.solution}\n`);
    console.log(`This challenge will be marked as skipped.\n`);
  }

  static showToolComplete(tool: string) {
    const info = this.TOOLS_INFO[tool as any];
    console.log(`\nðŸŽ‰ CONGRATULATIONS! You've completed all ${info.displayName} challenges!`);
    console.log(`ðŸŒŸ You're now ready to move on to the next tool!\n`);
  }

  static showProgress(state: GameState) {
    const totalChallenges = Object.values(challengesByTool).flat().length;
    const completed = state.completedChallenges.length;
    const percentage = Math.round((completed / totalChallenges) * 100);

    console.log(`\nðŸ“Š Overall Progress: ${completed}/${totalChallenges} (${percentage}%)`);

    // Show progress per tool
    Object.entries(state.toolProgress).forEach(([tool, progress]) => {
      const info = this.TOOLS_INFO[tool as any];
      console.log(`   ${info.icon} ${info.displayName}: ${progress}/5`);
    });

    if (completed === totalChallenges) {
      const timeSpent = Math.round((Date.now() - state.startTime) / 1000 / 60);
      console.log(`\nðŸŽŠ INCREDIBLE! You've completed all ${totalChallenges} challenges!`);
      console.log(`â±ï¸  Total time: ${timeSpent} minutes`);
      console.log(`ðŸŒŸ You're now a master of command-line tools!`);
    }
  }

  static showErrorMessage(message: string) {
    console.log(`\nâŒ Error: ${message}\n`);
  }

  static showSuccessMessage(message: string) {
    console.log(`\nâœ… ${message}\n`);
  }

  static showInfoMessage(message: string) {
    console.log(`\nâ„¹ï¸  ${message}\n`);
  }

  static createReadlineInterface() {
    return readline.createInterface({
      input: process.stdin,
      output: process.stdout,
      prompt: '> '
    });
  }
}