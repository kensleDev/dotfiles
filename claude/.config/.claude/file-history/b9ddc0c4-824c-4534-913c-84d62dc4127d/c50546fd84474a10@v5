<script lang="ts">
  import {
    Popover,
    PopoverContent,
    PopoverTrigger,
  } from "@/components/ui/popover";
  import { Check, ChevronDown, Filter } from "@lucide/svelte";

  interface Props {
    activeFilters: ("all" | "urls" | "text" | "shortlinks" | "unsafe")[];
    onFilterChange: (
      filters: ("all" | "urls" | "text" | "shortlinks" | "unsafe")[]
    ) => void;
  }

  let { activeFilters, onFilterChange } = $props();

  // Filter options using Svelte 5 state
  const filterOptions = $state([
    { key: "all", label: "All" },
    { key: "urls", label: "URLs" },
    { key: "text", label: "Text" },
    { key: "shortlinks", label: "Shortlinks" },
    { key: "unsafe", label: "Unsafe" },
  ]);

  // Popover state management
  let open = $state(false);

  function handleFilterToggle(
    filterKey: "all" | "urls" | "text" | "shortlinks" | "unsafe"
  ) {
    let finalFilters: ("all" | "urls" | "text" | "shortlinks" | "unsafe")[];

    if (filterKey === "all") {
      // If clicking "all", toggle between "all" and no filters
      finalFilters = activeFilters.includes("all") ? [] : ["all"];
    } else {
      // If clicking a specific filter
      if (activeFilters.includes("all")) {
        // If "all" is currently selected, replace it with the clicked filter
        finalFilters = [filterKey];
      } else {
        // Otherwise, toggle the specific filter
        finalFilters = activeFilters.includes(filterKey)
          ? activeFilters.filter((f: typeof filterKey) => f !== filterKey)
          : [...activeFilters, filterKey];
      }
    }

    // Only update if filters actually changed to prevent unnecessary re-renders
    const filtersChanged =
      JSON.stringify(activeFilters) !== JSON.stringify(finalFilters);
    if (filtersChanged) {
      onFilterChange(finalFilters);
    }
  }

  function getActiveFilterLabels() {
    if (activeFilters.length === 0) return "Filter";
    if (activeFilters.includes("all")) return "All";

    const labels = filterOptions
      .filter((option) =>
        activeFilters.includes(option.key as (typeof activeFilters)[0])
      )
      .map((option) => option.label);

    // If more than 2 filters selected, show count instead of all labels
    if (labels.length > 2) {
      return `${labels.length} selected`;
    }

    return labels.join(", ");
  }

  // Track open state for any future enhancements
  let wasOpen = $state(false);
</script>

<div class="filter-dropdown">
  <Popover bind:open>
    <PopoverTrigger>
      <button
        class="inline-flex items-center gap-2 pl-3 pr-4 py-1 text-sm font-medium bg-white/10 border border-white/20 rounded-lg text-white hover:bg-white/15 hover:text-white transition-colors focus:outline-none focus:ring-2 focus:ring-white/20 focus:border-white/30 min-h-[40px]"
        aria-label="Filter options"
        type="button"
      >
        <Filter class="w-4 h-4" />
        {getActiveFilterLabels()}
        <ChevronDown class="w-4 h-4" />
      </button>
    </PopoverTrigger>
    <PopoverContent
      class="w-48 p-0 border-0 bg-transparent shadow-none"
      align="start"
      side="bottom"
    >
      <!-- <GlassBackground class="p-2 rounded-md" blur="lg" opacity={0.9}> -->
      <div class="space-y-1 bg-gradient-to-br from-green-900/95 via-teal-900/95 to-blue-900/95 backdrop-blur-xl border border-white/30 p-2 rounded-md shadow-lg">
        {#each filterOptions as option}
          <button
            class="w-full text-left px-3 py-2 rounded-md text-sm transition-colors flex items-center gap-2 {activeFilters.includes(
              option.key as (typeof activeFilters)[0]
            )
              ? 'bg-white/30 text-white font-medium'
              : 'text-white hover:bg-white/20'}"
            onclick={() =>
              handleFilterToggle(
                option.key as "all" | "urls" | "text" | "shortlinks" | "unsafe"
              )}
            aria-pressed={activeFilters.includes(
              option.key as (typeof activeFilters)[0]
            )}
          >
            <input
              type="checkbox"
              checked={activeFilters.includes(
                option.key as (typeof activeFilters)[0]
              )}
              readonly
              class="pointer-events-none w-4 h-4 text-white"
            />
            {option.label}
            {#if activeFilters.includes(option.key as (typeof activeFilters)[0])}
              <Check class="w-4 h-4" />
            {/if}
          </button>
        {/each}
      </div>
      <!-- </GlassBackground> -->
    </PopoverContent>
  </Popover>
</div>
