<script module lang="ts">
  export type SortOption = {
    key: string;
    label: string;
    direction: "asc" | "desc";
  };

  export type SortDirection = "asc" | "desc";
</script>

<script lang="ts">
  import {
    Popover,
    PopoverContent,
    PopoverTrigger,
  } from "@/components/ui/popover";
  import { ArrowUpDown, Check, ChevronDown } from "@lucide/svelte";

  interface Props {
    currentSort: SortOption | null;
    onSortChange: (sort: SortOption | null) => void;
  }

  let { currentSort, onSortChange } = $props();

  // Sort options using Svelte 5 state
  const sortOptions: SortOption[] = $state([
    {
      key: "created_at",
      label: "Newest",
      direction: "desc",
    },
    {
      key: "created_at",
      label: "Oldest",
      direction: "asc",
    },
    { key: "data", label: "Content (A-Z)", direction: "asc" },
    { key: "data", label: "Content (Z-A)", direction: "desc" },
    {
      key: "visited",
      label: "Visited First",
      direction: "desc",
    },
    {
      key: "visited",
      label: "Unvisited First",
      direction: "asc",
    },
    { key: "isSafe", label: "Safe First", direction: "desc" },
    { key: "isSafe", label: "Unsafe First", direction: "asc" },
  ]);

  // Popover state management
  let open = $state(false);

  function handleSortSelect(option: SortOption) {
    // Close the dropdown immediately when a selection is made
    open = false;

    // If clicking the same option, toggle direction or clear if no direction change possible
    if (
      currentSort?.key === option.key &&
      currentSort?.direction === option.direction
    ) {
      onSortChange(null);
    } else {
      onSortChange(option);
    }
  }

  function getCurrentSortLabel() {
    if (!currentSort) return "Sort";

    const option = sortOptions.find(
      (opt) =>
        opt.key === currentSort.key && opt.direction === currentSort.direction
    );

    return option?.label || "Sort";
  }

  // Track open state for any future enhancements
  let wasOpen = $state(false);
</script>

<div class="sort-dropdown">
  <Popover bind:open>
    <PopoverTrigger>
      <button
        class="inline-flex items-center gap-2 pl-3 pr-4 py-1 text-sm font-medium bg-white/10 border border-white/20 rounded-lg text-white hover:bg-white/15 hover:text-white transition-colors focus:outline-none focus:ring-2 focus:ring-white/20 focus:border-white/30 min-h-[40px]"
        aria-label="Sort options"
        type="button"
      >
        <ArrowUpDown class="w-4 h-4" />
        {getCurrentSortLabel()}
        <ChevronDown class="w-4 h-4" />
      </button>
    </PopoverTrigger>
    <PopoverContent
      class="w-56 p-0 border-0 bg-transparent shadow-none"
      align="end"
      side="bottom"
    >
      <div class="space-y-1 bg-gradient-to-br from-green-500/90 via-teal-500/90 to-blue-500/90 backdrop-blur-xl border border-white/30 p-2 rounded-md shadow-lg">
        <div class="px-3 py-2 text-sm font-medium text-white mb-2">
          Sort by
        </div>
        {#each sortOptions as option}
          <button
            class="w-full text-left px-3 py-2 rounded-md text-sm transition-colors flex items-center justify-between {currentSort?.key ===
              option.key && currentSort?.direction === option.direction
              ? 'bg-white/30 text-white font-medium'
              : 'text-white hover:bg-white/20'}"
            onclick={() => handleSortSelect(option)}
            aria-pressed={currentSort?.key === option.key &&
              currentSort?.direction === option.direction}
          >
            <span>{option.label}</span>
            {#if currentSort?.key === option.key && currentSort?.direction === option.direction}
              <Check class="w-4 h-4" />
            {/if}
          </button>
        {/each}
      </div>
    </PopoverContent>
  </Popover>
</div>
